{"version":3,"file":"stimulus-autocomplete.mjs","sources":["../src/autocomplete.mjs"],"sourcesContent":["import { Controller } from 'stimulus'\nimport debounce from 'lodash.debounce'\nimport keycode from 'keycode'\n\nexport default class extends Controller {\n  static targets = ['input', 'hidden', 'results']\n\n  connect () {\n    this.previousSearch = null\n    this.resultsTarget.hidden = true\n\n    this.inputTarget.setAttribute('autocomplete', 'off')\n    this.inputTarget.setAttribute('spellcheck', 'false')\n\n    this.mouseDown = false\n\n    this.onInputChange = debounce(this.onInputChange.bind(this), 300)\n    this.onResultsClick = this.onResultsClick.bind(this)\n    this.onResultsMouseDown = this.onResultsMouseDown.bind(this)\n    this.onResultsMouseOver = this.onResultsMouseOver.bind(this)\n    this.onInputBlur = this.onInputBlur.bind(this)\n    this.onInputFocus = this.onInputFocus.bind(this)\n    this.onKeydown = this.onKeydown.bind(this)\n\n    this.inputTarget.addEventListener('keydown', this.onKeydown)\n    this.inputTarget.addEventListener('focus', this.onInputFocus)\n    this.inputTarget.addEventListener('blur', this.onInputBlur)\n    this.inputTarget.addEventListener('input', this.onInputChange)\n    this.resultsTarget.addEventListener('mousedown', this.onResultsMouseDown)\n    this.resultsTarget.addEventListener('mouseover', this.onResultsMouseOver)\n    this.resultsTarget.addEventListener('click', this.onResultsClick)\n  }\n\n  disconnect () {\n    this.inputTarget.removeEventListener('keydown', this.onKeydown)\n    this.inputTarget.removeEventListener('focus', this.onInputFocus)\n    this.inputTarget.removeEventListener('blur', this.onInputBlur)\n    this.inputTarget.removeEventListener('input', this.onInputChange)\n    this.resultsTarget.removeEventListener('mousedown', this.onResultsMouseDown)\n    this.resultsTarget.removeEventListener('mouseover', this.onResultsMouseOver)\n    this.resultsTarget.removeEventListener('click', this.onResultsClick)\n  }\n\n  sibling (next) {\n    const options = Array.from(this.resultsTarget.querySelectorAll('[role=\"option\"]'))\n    const selected = this.resultsTarget.querySelector('[aria-selected=\"true\"]')\n    const index = options.indexOf(selected)\n    const sibling = next ? options[index + 1] : options[index - 1]\n    const def = next ? options[0] : options[options.length - 1]\n    return sibling || def\n  }\n\n  select (target) {\n    for (const el of this.resultsTarget.querySelectorAll('[aria-selected=\"true\"]')) {\n      el.removeAttribute('aria-selected')\n      el.classList.remove(...this.activeClassList)\n    }\n    target.setAttribute('aria-selected', 'true')\n    target.classList.add(...this.activeClassList)\n    this.inputTarget.setAttribute('aria-activedescendant', target.id)\n  }\n\n  onKeydown (event) {\n    switch (keycode(event)) {\n      case 'esc':\n        if (!this.resultsTarget.hidden) {\n          this.hideAndRemoveOptions()\n          event.stopPropagation()\n          event.preventDefault()\n        }\n        break\n      case 'down':\n        {\n          const item = this.sibling(true)\n          if (item) this.select(item)\n          event.preventDefault()\n        }\n        break\n      case 'up':\n        {\n          const item = this.sibling(false)\n          if (item) this.select(item)\n          event.preventDefault()\n        }\n        break\n      case 'tab':\n        {\n          const selected = this.resultsTarget.querySelector('[aria-selected=\"true\"]')\n          if (selected) {\n            this.commit(selected)\n          }\n        }\n        break\n      case 'enter':\n        {\n          const selected = this.resultsTarget.querySelector('[aria-selected=\"true\"]')\n          if (selected && !this.resultsTarget.hidden) {\n            this.commit(selected)\n            event.preventDefault()\n          }\n        }\n        break\n    }\n  }\n\n  onInputFocus () {\n    this.element.dispatchEvent(new CustomEvent('autocomplete.focus', {\n      bubbles: true\n    }))\n    this.fetchResults()\n  }\n\n  onInputBlur () {\n    if (this.mouseDown) return\n    this.element.dispatchEvent(new CustomEvent('autocomplete.blur', {\n      bubbles: true\n    }))\n    this.resultsTarget.hidden = true\n  }\n\n  commit (selected) {\n    if (selected.getAttribute('aria-disabled') === 'true') return\n\n    if (selected instanceof HTMLAnchorElement) {\n      selected.click()\n      this.resultsTarget.hidden = true\n      return\n    }\n\n    if (selected instanceof HTMLFormElement) {\n      selected.submit()\n      this.resultsTarget.hidden = true\n      return\n    }\n\n    const textValue = selected.textContent.trim()\n    const value = selected.getAttribute('data-autocomplete-value') || textValue\n    const data = selected.getAttribute('data-autocomplete-data') || \"\"\n\n    this.onSelect(selected, textValue, value)\n\n    if (this.hasHiddenTarget) {\n      this.hiddenTarget.value = value\n      this.hiddenTarget.dispatchEvent(new Event('change'))\n    } else {\n      this.inputTarget.value = value\n    }\n\n    this.element.dispatchEvent(new CustomEvent('autocomplete.change', {\n      bubbles: true,\n      detail: { value: value, textValue: textValue, data: data }\n    }))\n\n    this.inputTarget.focus()\n    this.hideAndRemoveOptions()\n  }\n\n  onSelect (selected, textValue, value) {\n    this.inputTarget.value = selected.getAttribute('data-autocomplete-content') || selected.textContent.trim()\n    this.previousSearch = this.inputTarget.value\n  }\n\n  onResultsClick (event) {\n    if (!(event.target instanceof Element)) return\n    const selected = event.target.closest('[role=\"option\"]')\n    if (selected) this.commit(selected)\n  }\n\n  onResultsMouseOver (event) {\n    if (!(event.target instanceof Element)) return\n    const selected = event.target.closest('[role=\"option\"]')\n    if (selected) this.select(selected)\n  }\n\n\n  onResultsMouseDown () {\n    this.mouseDown = true\n    this.resultsTarget.addEventListener('mouseup', () => (this.mouseDown = false), { once: true })\n  }\n\n  onInputChange () {\n    this.element.removeAttribute('value')\n    this.fetchResults()\n  }\n\n  identifyOptions () {\n    let id = 0\n    for (const el of this.resultsTarget.querySelectorAll('[role=\"option\"]:not([id])')) {\n      el.id = `${this.resultsTarget.id}-option-${id++}`\n    }\n  }\n\n  hideAndRemoveOptions () {\n    this.resultsTarget.hidden = true\n    this.resultsTarget.innerHTML = null\n  }\n\n  fetchResults () {\n    const query = this.inputTarget.value.trim()\n    if (!query || query.length < this.minLength || query === this.previousSearch) {\n      this.hideAndRemoveOptions()\n      return\n    }\n\n    if (!this.src) return\n\n    const url = new URL(this.src, window.location.href)\n    const params = new URLSearchParams(url.search.slice(1))\n    params.append(this.queryParam, query)\n    url.search = params.toString()\n\n    this.element.dispatchEvent(new CustomEvent('loadstart'))\n\n    fetch(url.toString())\n      .then(response => this.handleAutocompleteResponse(response))\n      .then(html => {\n        this.resultsTarget.innerHTML = html\n        this.identifyOptions()\n        const hasResults = !!this.resultsTarget.querySelector('[role=\"option\"]')\n        this.resultsTarget.hidden = !hasResults\n        this.element.dispatchEvent(new CustomEvent('load'))\n        this.element.dispatchEvent(new CustomEvent('loadend'))\n      })\n      .catch(() => {\n        this.element.dispatchEvent(new CustomEvent('error'))\n        this.element.dispatchEvent(new CustomEvent('loadend'))\n      })\n  }\n\n  handleAutocompleteResponse (response) {\n    return response.text()\n  }\n\n  open () {\n    if (!this.resultsTarget.hidden) return\n    this.resultsTarget.hidden = false\n    this.element.setAttribute('aria-expanded', 'true')\n    this.element.dispatchEvent(new CustomEvent('toggle', { detail: { input: this.input, results: this.results } }))\n  }\n\n  close () {\n    if (this.resultsTarget.hidden) return\n    this.resultsTarget.hidden = true\n    this.inputTarget.removeAttribute('aria-activedescendant')\n    this.element.setAttribute('aria-expanded', 'false')\n    this.element.dispatchEvent(new CustomEvent('toggle', { detail: { input: this.input, results: this.results } }))\n  }\n\n  get activeClassList () {\n    const classString = this.data.has('active-class') ? this.data.get('active-class') : 'active';\n    return classString.split(' ').map(s => s.trim()).filter(s => s != null && s != \"\")\n  }\n\n  get queryParam () {\n    return this.data.has('query') ? this.data.get('query') : 'q'\n  }\n\n  get src () {\n    return this.data.get(\"url\")\n  }\n\n  get minLength () {\n    const minLength = this.data.get(\"min-length\")\n    if (!minLength) {\n      return 0\n    }\n    return parseInt(minLength, 10)\n  }\n}\n"],"names":["connect","previousSearch","resultsTarget","hidden","inputTarget","setAttribute","mouseDown","onInputChange","debounce","this","bind","onResultsClick","onResultsMouseDown","onResultsMouseOver","onInputBlur","onInputFocus","onKeydown","addEventListener","disconnect","removeEventListener","sibling","next","options","Array","from","querySelectorAll","selected","querySelector","index","indexOf","length","select","target","const","el","removeAttribute","classList","remove","ref","activeClassList","add","ref$1","id","event","keycode","hideAndRemoveOptions","stopPropagation","preventDefault","item","commit","element","dispatchEvent","CustomEvent","bubbles","fetchResults","getAttribute","HTMLAnchorElement","click","HTMLFormElement","submit","textValue","textContent","trim","value","data","onSelect","hasHiddenTarget","hiddenTarget","Event","detail","focus","Element","closest","once","identifyOptions","innerHTML","query","minLength","src","url","URL","window","location","href","params","URLSearchParams","search","slice","append","queryParam","toString","fetch","then","response","handleAutocompleteResponse","html","hasResults","catch","text","open","input","results","close","has","get","split","map","s","filter","parseInt","Controller","targets"],"mappings":"4FAIA,gRAGEA,wBACOC,eAAiB,UACjBC,cAAcC,QAAS,OAEvBC,YAAYC,aAAa,eAAgB,YACzCD,YAAYC,aAAa,aAAc,cAEvCC,WAAY,OAEZC,cAAgBC,EAASC,KAAKF,cAAcG,KAAKD,MAAO,UACxDE,eAAiBF,KAAKE,eAAeD,KAAKD,WAC1CG,mBAAqBH,KAAKG,mBAAmBF,KAAKD,WAClDI,mBAAqBJ,KAAKI,mBAAmBH,KAAKD,WAClDK,YAAcL,KAAKK,YAAYJ,KAAKD,WACpCM,aAAeN,KAAKM,aAAaL,KAAKD,WACtCO,UAAYP,KAAKO,UAAUN,KAAKD,WAEhCL,YAAYa,iBAAiB,UAAWR,KAAKO,gBAC7CZ,YAAYa,iBAAiB,QAASR,KAAKM,mBAC3CX,YAAYa,iBAAiB,OAAQR,KAAKK,kBAC1CV,YAAYa,iBAAiB,QAASR,KAAKF,oBAC3CL,cAAce,iBAAiB,YAAaR,KAAKG,yBACjDV,cAAce,iBAAiB,YAAaR,KAAKI,yBACjDX,cAAce,iBAAiB,QAASR,KAAKE,6BAGpDO,2BACOd,YAAYe,oBAAoB,UAAWV,KAAKO,gBAChDZ,YAAYe,oBAAoB,QAASV,KAAKM,mBAC9CX,YAAYe,oBAAoB,OAAQV,KAAKK,kBAC7CV,YAAYe,oBAAoB,QAASV,KAAKF,oBAC9CL,cAAciB,oBAAoB,YAAaV,KAAKG,yBACpDV,cAAciB,oBAAoB,YAAaV,KAAKI,yBACpDX,cAAciB,oBAAoB,QAASV,KAAKE,6BAGvDS,iBAASC,OACDC,EAAUC,MAAMC,KAAKf,KAAKP,cAAcuB,iBAAiB,oBACzDC,EAAWjB,KAAKP,cAAcyB,cAAc,0BAC5CC,EAAQN,EAAQO,QAAQH,UACdL,EAAOC,EAAQM,EAAQ,GAAKN,EAAQM,EAAQ,MAChDP,EAAOC,EAAQ,GAAKA,EAAQA,EAAQQ,OAAS,iBAI3DC,gBAAQC,qBACWvB,KAAKP,cAAcuB,iBAAiB,0CAA2B,CAA3EQ,IAAMC,OACTA,EAAGC,gBAAgB,oBACnBD,EAAGE,WAAUC,aAAOC,EAAG7B,KAAK8B,iBAE9BP,EAAO3B,aAAa,gBAAiB,WACrC2B,EAAOI,WAAUI,UAAIC,EAAGhC,KAAK8B,sBACxBnC,YAAYC,aAAa,wBAAyB2B,EAAOU,iBAGhE1B,mBAAW2B,UACDC,EAAQD,QACT,MACElC,KAAKP,cAAcC,cACjB0C,uBACLF,EAAMG,kBACNH,EAAMI,4BAGL,WAEKC,EAAOvC,KAAKW,SAAQ,GACtB4B,GAAMvC,KAAKsB,OAAOiB,GACtBL,EAAMI,2BAGL,SAEKC,EAAOvC,KAAKW,SAAQ,GACtB4B,GAAMvC,KAAKsB,OAAOiB,GACtBL,EAAMI,2BAGL,UAEKrB,EAAWjB,KAAKP,cAAcyB,cAAc,0BAC9CD,QACGuB,OAAOvB,aAIb,YAEKA,EAAWjB,KAAKP,cAAcyB,cAAc,0BAC9CD,IAAajB,KAAKP,cAAcC,cAC7B8C,OAAOvB,GACZiB,EAAMI,gCAOhBhC,6BACOmC,QAAQC,cAAc,IAAIC,YAAY,qBAAsB,CAC/DC,SAAS,UAENC,4BAGPxC,uBACML,KAAKH,iBACJ4C,QAAQC,cAAc,IAAIC,YAAY,oBAAqB,CAC9DC,SAAS,UAENnD,cAAcC,QAAS,gBAG9B8C,gBAAQvB,MACyC,SAA3CA,EAAS6B,aAAa,qBAEtB7B,aAAoB8B,yBACtB9B,EAAS+B,kBACJvD,cAAcC,QAAS,MAI1BuB,aAAoBgC,uBACtBhC,EAASiC,mBACJzD,cAAcC,QAAS,OAIxByD,EAAYlC,EAASmC,YAAYC,OACjCC,EAAQrC,EAAS6B,aAAa,4BAA8BK,EAC5DI,EAAOtC,EAAS6B,aAAa,2BAA6B,QAE3DU,SAASvC,EAAUkC,EAAWG,GAE/BtD,KAAKyD,sBACFC,aAAaJ,MAAQA,OACrBI,aAAahB,cAAc,IAAIiB,MAAM,iBAErChE,YAAY2D,MAAQA,OAGtBb,QAAQC,cAAc,IAAIC,YAAY,sBAAuB,CAChEC,SAAS,EACTgB,OAAQ,CAAEN,MAAOA,EAAOH,UAAWA,EAAWI,KAAMA,WAGjD5D,YAAYkE,aACZzB,qCAGPoB,kBAAUvC,EAAUkC,EAAWG,QACxB3D,YAAY2D,MAAQrC,EAAS6B,aAAa,8BAAgC7B,EAASmC,YAAYC,YAC/F7D,eAAiBQ,KAAKL,YAAY2D,mBAGzCpD,wBAAgBgC,MACRA,EAAMX,kBAAkBuC,aACxB7C,EAAWiB,EAAMX,OAAOwC,QAAQ,mBAClC9C,GAAUjB,KAAKwC,OAAOvB,iBAG5Bb,4BAAoB8B,MACZA,EAAMX,kBAAkBuC,aACxB7C,EAAWiB,EAAMX,OAAOwC,QAAQ,mBAClC9C,GAAUjB,KAAKsB,OAAOL,iBAI5Bd,8CACON,WAAY,OACZJ,cAAce,iBAAiB,4BAAkBR,EAAKH,WAAY,GAAQ,CAAEmE,MAAM,iBAGzFlE,8BACO2C,QAAQf,gBAAgB,cACxBmB,4BAGPoB,mCACMhC,EAAK,QACQjC,KAAKP,cAAcuB,iBAAiB,kDAChDiB,GAAQjC,KAAKP,4BAA2BwC,iBAI/CG,qCACO3C,cAAcC,QAAS,OACvBD,cAAcyE,UAAY,kBAGjCrB,mCACQsB,EAAQnE,KAAKL,YAAY2D,MAAMD,WAChCc,GAASA,EAAM9C,OAASrB,KAAKoE,WAAaD,IAAUnE,KAAKR,oBACvD4C,+BAIFpC,KAAKqE,SAEJC,EAAM,IAAIC,IAAIvE,KAAKqE,IAAKG,OAAOC,SAASC,MACxCC,EAAS,IAAIC,gBAAgBN,EAAIO,OAAOC,MAAM,IACpDH,EAAOI,OAAO/E,KAAKgF,WAAYb,GAC/BG,EAAIO,OAASF,EAAOM,gBAEfxC,QAAQC,cAAc,IAAIC,YAAY,cAE3CuC,MAAMZ,EAAIW,YACPE,cAAKC,UAAYpF,EAAKqF,2BAA2BD,KACjDD,cAAKG,KACC7F,cAAcyE,UAAYoB,IAC1BrB,sBACCsB,IAAevF,EAAKP,cAAcyB,cAAc,qBACjDzB,cAAcC,QAAU6F,IACxB9C,QAAQC,cAAc,IAAIC,YAAY,WACtCF,QAAQC,cAAc,IAAIC,YAAY,cAE5C6C,mBACM/C,QAAQC,cAAc,IAAIC,YAAY,YACtCF,QAAQC,cAAc,IAAIC,YAAY,4BAIjD0C,oCAA4BD,UACnBA,EAASK,oBAGlBC,gBACO1F,KAAKP,cAAcC,cACnBD,cAAcC,QAAS,OACvB+C,QAAQ7C,aAAa,gBAAiB,aACtC6C,QAAQC,cAAc,IAAIC,YAAY,SAAU,CAAEiB,OAAQ,CAAE+B,MAAO3F,KAAK2F,MAAOC,QAAS5F,KAAK4F,0BAGpGC,iBACM7F,KAAKP,cAAcC,cAClBD,cAAcC,QAAS,OACvBC,YAAY+B,gBAAgB,8BAC5Be,QAAQ7C,aAAa,gBAAiB,cACtC6C,QAAQC,cAAc,IAAIC,YAAY,SAAU,CAAEiB,OAAQ,CAAE+B,MAAO3F,KAAK2F,MAAOC,QAAS5F,KAAK4F,gBAGhG9D,sCACkB9B,KAAKuD,KAAKuC,IAAI,gBAAkB9F,KAAKuD,KAAKwC,IAAI,gBAAkB,UACjEC,MAAM,KAAKC,aAAIC,UAAKA,EAAE7C,SAAQ8C,gBAAOD,UAAU,MAALA,GAAkB,IAALA,OAGxElB,iCACKhF,KAAKuD,KAAKuC,IAAI,SAAW9F,KAAKuD,KAAKwC,IAAI,SAAW,OAGvD1B,0BACKrE,KAAKuD,KAAKwC,IAAI,UAGnB3B,6BACIA,EAAYpE,KAAKuD,KAAKwC,IAAI,qBAC3B3B,EAGEgC,SAAShC,EAAW,IAFlB,6CApQgBiC,KACpBC,QAAU,CAAC,QAAS,SAAU"}